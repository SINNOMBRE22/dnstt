#!/usr/bin/env bash
# Start SlowDNS - SINNOMBRE22

clear

# ==================================================
# ðŸ“Œ COLORES OFICIALES SINNOMBRE22
# ==================================================
R='\033[0;31m'; G='\033[0;32m'; Y='\033[1;33m'; B='\033[0;34m'
M='\033[0;35m'; C='\033[0;36m'; W='\033[1;37m'; N='\033[0m'
BOLD='\033[1m'
ROJO="\e[31m"; BLANCO="\e[97m"; CYAN="\e[36m"; AMARILLO="\e[33m"; RESET="\e[0m"

# ==================================================
# ðŸ“Œ LÃNEA OFICIAL
# ==================================================
LINEA="${ROJO}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• / / / â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"

# ==================================================
# ðŸ“Œ BARRA OFICIAL
# ==================================================
barra_progreso() {
comando="$1"
(
[[ -e $HOME/fim ]] && rm $HOME/fim
$comando > /dev/null 2>&1
touch $HOME/fim
) > /dev/null 2>&1 &

tput civis
echo -ne "${CYAN}ESPERANDO ${ROJO}["
while true; do
   for((i=0; i<18; i++)); do
      echo -ne "#"
      sleep 0.08
   done
   [[ -e $HOME/fim ]] && rm $HOME/fim && break
   echo -e "]"
   sleep 1
   tput cuu1
   tput dl1
   echo -ne "${CYAN}ESPERANDO ${ROJO}["
done
echo -e "] ${G}OK${RESET}"
tput cnorm
}

# ==================================================
# ðŸ“Œ TÃTULO
# ==================================================
echo -e "$LINEA"
echo -e "${BOLD}${BLANCO}                INICIANDO SLOWDNS - SINNOMBRE22                ${RESET}"
echo -e "$LINEA"

# ==================================================
# VERIFICAR INSTALACIÃ“N
# ==================================================
if [ ! -f /etc/slowdns/dns-server ]; then
    echo
    echo -e "${R}âœ– SlowDNS no estÃ¡ instalado${RESET}"
    sleep 2
    exit 1
fi

# ==================================================
# FUNCIÃ“N INICIO
# ==================================================
fun_start () {

# Verificar si ya estÃ¡ activo
if screen -ls | grep -q slowdns; then
    echo -e "${Y}âš  SlowDNS ya estÃ¡ en ejecuciÃ³n${RESET}"
    sleep 2
    return
fi

# Obtener NS guardado
if [ -f /etc/slowdns/infons ]; then
    nameserver=$(cat /etc/slowdns/infons)
else
    echo -e "${R}âœ– No se encontrÃ³ archivo de NS${RESET}"
    exit 1
fi

# Detectar puerto configurado
if [ -f /etc/slowdns/startdns ]; then
    custom_port=$(grep 127.0.0.1 /etc/slowdns/startdns | awk -F':' '{print $NF}')
else
    custom_port="443"
fi

cd /etc/slowdns || exit 1

screen -dmS slowdns /etc/slowdns/dns-server \
-udp :5300 \
-privkey-file /root/server.key \
$nameserver 127.0.0.1:$custom_port

sleep 2
}

# ==================================================
# EJECUTAR
# ==================================================
barra_progreso fun_start

echo
echo -e "${G}âœ” SlowDNS iniciado correctamente${RESET}"
echo
read -p "Presiona ENTER para continuar..."

# Volver al menÃº si existe
if command -v slowdns >/dev/null 2>&1; then
    slowdns
else
    exit
fi