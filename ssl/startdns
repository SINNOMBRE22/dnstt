#!/bin/bash
# Start SlowDNS - SINNOMBRE22

clear

fun_bar () {
comando="$1"
(
[[ -e $HOME/fim ]] && rm $HOME/fim
$comando > /dev/null 2>&1
touch $HOME/fim
) > /dev/null 2>&1 &
tput civis
echo -ne "  \033[1;33mINICIANDO \033[1;37m- \033[1;33m["
while true; do
   for((i=0; i<18; i++)); do
      echo -ne "\033[1;31m#"
      sleep 0.1s
   done
   [[ -e $HOME/fim ]] && rm $HOME/fim && break
   echo -e "\033[1;33m]"
   sleep 1s
   tput cuu1
   tput dl1
   echo -ne "  \033[1;33mINICIANDO \033[1;37m- \033[1;33m["
done
echo -e "\033[1;33m]\033[1;37m - \033[1;32mOK!\033[0m"
tput cnorm
}

echo "══════════════════════════════════════"
echo "     INICIANDO SLOWDNS - SINNOMBRE22"
echo "══════════════════════════════════════"

# Verificar instalación
if [ ! -f /etc/slowdns/dns-server ]; then
    echo ""
    echo -e "\033[1;31mSlowDNS no está instalado.\033[0m"
    sleep 2
    exit 1
fi

fun_start () {

# Verificar si ya está corriendo
if screen -ls | grep -q slowdns; then
    echo "SlowDNS ya está en ejecución."
    sleep 2
    return
fi

# Obtener NS
if [ -f /etc/slowdns/infons ]; then
    nameserver=$(cat /etc/slowdns/infons)
else
    echo "No se encontró el archivo de NS."
    exit 1
fi

# Detectar puerto configurado
if [ -f /etc/slowdns/startdns ]; then
    custom_port=$(grep 127.0.0.1 /etc/slowdns/startdns | awk -F':' '{print $NF}')
else
    custom_port="443"
fi

cd /etc/slowdns

screen -dmS slowdns /etc/slowdns/dns-server \
-udp :5300 \
-privkey-file /root/server.key \
$nameserver 127.0.0.1:$custom_port

sleep 2
}

fun_bar fun_start

echo ""
echo -e "\033[1;32mSlowDNS iniciado correctamente ✔\033[0m"
echo ""
read -p "Presiona ENTER para continuar..."

# Volver al menú si existe
if command -v slowdns >/dev/null 2>&1; then
    slowdns
else
    exit
fi