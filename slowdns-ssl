#!/bin/bash

# Verificar root
if [[ $EUID -ne 0 ]]; then
   echo "Este script debe ejecutarse como root"
   exit 1
fi

clear

# Colores
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
WHITE='\033[1;37m'
RESET='\033[0m'

# Barra de progreso corregida
fun_bar() {
    (
        $1 > /dev/null 2>&1
        touch $HOME/fim
    ) &

    tput civis
    echo -ne "  ESPERANDO ["
    while true; do
        for ((i=0;i<18;i++)); do
            echo -ne "#"
            sleep 0.1
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -ne "]"
        sleep 1
        tput cuu1 && tput dl1
        echo -ne "  ESPERANDO ["
    done
    echo -e "] OK"
    tput cnorm
}

# Encabezado
echo -e "${YELLOW}========================================${RESET}"
echo -e "${GREEN}        INSTALADOR SLOWDNS SSL${RESET}"
echo -e "${YELLOW}========================================${RESET}"
echo ""

# Actualizar sistema
echo "Actualizando sistema..."
fun_bar "apt update && apt upgrade -y"

# Instalar dependencias
echo "Instalando dependencias..."
fun_bar "apt install screen cron iptables figlet -y"

# Crear directorio si no existe
mkdir -p /etc/slowdns
cd /etc/slowdns || exit 1

# Pedir NS
echo ""
read -p "Ingresa tu Nameserver (NS): " nameserver
echo "$nameserver" > /etc/slowdns/infons

# Descargar start y restart
descargar_scripts() {
wget -q https://raw.githubusercontent.com/powermx/dnstt/main/ssl/startdns
wget -q https://raw.githubusercontent.com/powermx/dnstt/main/ssl/restartdns
chmod +x startdns restartdns
sed -i "s;1234;$nameserver;g" startdns restartdns
cp startdns restartdns /bin/
}
fun_bar descargar_scripts

# Función configurar iptables
configurar_iptables() {
iptables -I INPUT -p udp --dport 5300 -j ACCEPT
iptables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 5300
}
 
# Verificar claves
cd /root
if [[ -f server.key && -f server.pub ]]; then
    echo ""
    echo "Se encontraron claves existentes."
    echo "[1] Usar claves actuales"
    echo "[2] Generar nuevas claves"
    echo "[3] Usar claves por defecto"
    echo "[x] Cancelar"
    read -p "Selecciona una opción: " opcion
else
    echo ""
    echo "No se encontraron claves."
    echo "[1] Generar nuevas claves"
    echo "[2] Usar claves por defecto"
    echo "[x] Cancelar"
    read -p "Selecciona una opción: " opcion
fi

case $opcion in

1)
    if [[ -f server.key && -f server.pub ]]; then
        echo "Usando claves actuales..."
    else
        echo "Generando nuevas claves..."
        cd /etc/slowdns
        ./dns-server -gen-key -privkey-file /root/server.key -pubkey-file /root/server.pub
    fi
;;

2)
    if [[ -f server.key && -f server.pub ]]; then
        echo "Generando nuevas claves..."
        rm -f /root/server.key /root/server.pub
        cd /etc/slowdns
        ./dns-server -gen-key -privkey-file /root/server.key -pubkey-file /root/server.pub
    else
        echo "Descargando claves por defecto..."
        cd /root
        wget -q https://raw.githubusercontent.com/powermx/dnstt/main/server.key
        wget -q https://raw.githubusercontent.com/powermx/dnstt/main/server.pub
    fi
;;

3)
    echo "Descargando claves por defecto..."
    cd /root
    wget -q https://raw.githubusercontent.com/powermx/dnstt/main/server.key
    wget -q https://raw.githubusercontent.com/powermx/dnstt/main/server.pub
;;

x)
    echo "Instalación cancelada."
    exit
;;

*)
    echo "Opción inválida."
    exit
;;

esac

# Copiar claves
cp /root/server.key /root/server.pub /etc/slowdns/

# Configurar firewall
configurar_iptables

# Iniciar servicio
cd /etc/slowdns
./startdns

clear
figlet SlowDNS

echo -e "${GREEN}INSTALACIÓN COMPLETADA ✔${RESET}"
echo ""
echo -e "${YELLOW}Tu NS:${RESET} $(cat /etc/slowdns/infons)"
echo ""
echo -e "${YELLOW}Tu clave pública:${RESET}"
cat /root/server.pub
echo ""
echo -e "${YELLOW}Archivo guardado en:${RESET} /root/server.pub"
echo ""
read -p "Presiona ENTER para continuar..."
slowdns