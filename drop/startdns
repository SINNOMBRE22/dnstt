#!/bin/bash
# Iniciar SlowDNS - Versión Corregida

clear

fun_bar () {
comando="$1"
(
[[ -e $HOME/fim ]] && rm $HOME/fim
$comando > /dev/null 2>&1
touch $HOME/fim
) > /dev/null 2>&1 &

tput civis
echo -ne "  \033[1;33mINICIANDO \033[1;37m- \033[1;33m["

while true; do
   for((i=0; i<18; i++)); do
      echo -ne "\033[1;31m#"
      sleep 0.1s
   done
   [[ -e $HOME/fim ]] && rm $HOME/fim && break
   echo -e "\033[1;33m]"
   sleep 1
   tput cuu1
   tput dl1
   echo -ne "  \033[1;33mINICIANDO \033[1;37m- \033[1;33m["
done

echo -e "\033[1;33m]\033[1;37m - \033[1;32mOK!\033[0m"
tput cnorm
}

echo "═══════════════════════════════"
echo "       INICIANDO SLOWDNS"
echo "═══════════════════════════════"

fun_start () {

# Verificar instalación
if [ ! -f /etc/slowdns/dns-server ]; then
   echo "SlowDNS no está instalado."
   sleep 2
   exit 1
fi

# Verificar si ya está activo
if pgrep -f dns-server > /dev/null; then
   echo "SlowDNS ya está en ejecución."
   sleep 2
   return
fi

# Obtener NS guardado
if [ -f /etc/slowdns/infons ]; then
   nameserver=$(cat /etc/slowdns/infons)
else
   echo "No se encontró el NS configurado."
   exit 1
fi

# Detectar puerto configurado automáticamente
if [ -f /etc/slowdns/startdns ]; then
   custom_port=$(grep 127.0.0.1 /etc/slowdns/startdns | awk -F':' '{print $NF}')
else
   custom_port="8080"
fi

cd /etc/slowdns

screen -dmS slowdns /etc/slowdns/dns-server \
-udp :5300 \
-privkey-file /root/server.key \
$nameserver 127.0.0.1:$custom_port

sleep 2
}

fun_bar fun_start

echo ""
echo -e "\033[1;32mSlowDNS iniciado correctamente ✔\033[0m"
echo ""
echo -e "\033[1;33m › PRESIONE ENTER PARA CONTINUAR\033[0m"
read -p " "

slowdns