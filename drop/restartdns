#!/usr/bin/env bash
# Reiniciar SlowDNS - SINNOMBRE22 PRO

clear

# ==================================================
# üìå COLORES OFICIALES
# ==================================================
R='\033[0;31m'; G='\033[0;32m'; Y='\033[1;33m'
W='\033[1;37m'; CYAN='\033[0;36m'; RESET='\033[0m'
BOLD='\033[1m'
ROJO="\e[31m"; BLANCO="\e[97m"

LINEA="${ROJO}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê / / / ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"

# ==================================================
# üìå BARRA OFICIAL
# ==================================================
barra_progreso() {
comando="$1"
(
[[ -e $HOME/fim ]] && rm $HOME/fim
$comando > /dev/null 2>&1
touch $HOME/fim
) > /dev/null 2>&1 &

tput civis
echo -ne "${CYAN}ESPERANDO ${ROJO}["
while true; do
   for((i=0; i<18; i++)); do
      echo -ne "#"
      sleep 0.08
   done
   [[ -e $HOME/fim ]] && rm $HOME/fim && break
   echo -e "]"
   sleep 1
   tput cuu1
   tput dl1
   echo -ne "${CYAN}ESPERANDO ${ROJO}["
done
echo -e "] ${G}OK${RESET}"
tput cnorm
}

# ==================================================
# üìå T√çTULO
# ==================================================
echo -e "$LINEA"
echo -e "${BOLD}${BLANCO}           REINICIANDO SLOWDNS - SINNOMBRE22           ${RESET}"
echo -e "$LINEA"

# ==================================================
# FUNCI√ìN RESTART
# ==================================================
fun_start () {

# Verificar instalaci√≥n
if [ ! -f /etc/slowdns/dns-server ]; then
   echo -e "${R}‚úñ SlowDNS no est√° instalado${RESET}"
   sleep 2
   exit 1
fi

# Matar procesos correctamente
pkill -f dns-server > /dev/null 2>&1
screen -wipe > /dev/null 2>&1
sleep 2

# Obtener NS guardado
if [ -f /etc/slowdns/infons ]; then
   nameserver=$(cat /etc/slowdns/infons)
else
   echo -e "${R}‚úñ No se encontr√≥ el NS configurado${RESET}"
   exit 1
fi

# Detectar puerto autom√°ticamente
if [ -f /etc/slowdns/startdns ]; then
   custom_port=$(grep 127.0.0.1 /etc/slowdns/startdns | awk -F':' '{print $NF}')
else
   custom_port="8080"
fi

cd /etc/slowdns || exit 1

screen -dmS slowdns /etc/slowdns/dns-server \
-udp :5300 \
-privkey-file /root/server.key \
$nameserver 127.0.0.1:$custom_port

sleep 2
}

# ==================================================
# EJECUTAR
# ==================================================
barra_progreso fun_start

echo
echo -e "${G}‚úî SlowDNS reiniciado correctamente${RESET}"
echo
echo -e "${Y}‚Ä∫ PRESIONE ENTER PARA CONTINUAR${RESET}"
read -p " "

slowdns