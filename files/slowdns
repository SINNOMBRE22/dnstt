#!/bin/bash
clear
#——————————————————
# CLIENTE SLOWDNS TERMUX
# Modificado y corregido
#——————————————————

RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
SCOLOR='\033[0m'

banner='
 ___ _    _____      _____  _  _ ___ 
/ __| |  / _ \ \    / /   \| \| / __|
\__ \ |_| (_) \ \/\/ /| |) | .  \__ \
|___/____\___/ \_/\_/ |___/|_|\_|___/
'

echo -e "${BLUE}=====================================${SCOLOR}"
echo -e "${BLUE}        CLIENTE SSHPLUS SLOWDNS     ${SCOLOR}"
echo -e "${BLUE}=====================================${SCOLOR}"
echo -e "${RED}$banner${SCOLOR}"

# Instalar script dns si no existe
if [[ ! -f "$HOME/dns" ]]; then
    echo -e "\n${YELLOW}Descargando componente DNS...${SCOLOR}"
    pkg install curl -y > /dev/null 2>&1
    curl -s -o $HOME/dns https://raw.githubusercontent.com/khaledagn/DNS-AGN/main/files/dns
    chmod +x $HOME/dns
    echo -e "${GREEN}Componente descargado correctamente.${SCOLOR}"
fi

# Configurar credenciales
if [[ ! -f "$HOME/credenciales" ]]; then
    ns="$1"
    chave="$2"

    if [[ -z "$ns" || -z "$chave" ]]; then
        echo -e "\n${RED}Uso correcto:${SCOLOR}"
        echo -e "${YELLOW}slowdns <NS> <CLAVE_PUBLICA> [DNS_IP]${SCOLOR}"
        exit 1
    fi

    echo -e "$ns\n$chave" > $HOME/credenciales
else
    echo -e "\n${YELLOW}El script ya está configurado.${SCOLOR}"
    read -p "$(echo -e "${GREEN}¿Desea continuar con la misma configuración? (s/n): ${SCOLOR}")" opc

    if [[ ! "$opc" =~ ^(s|S|si|SI)$ ]]; then
        rm -f $HOME/credenciales
        echo -e "${RED}Configuración eliminada. Ejecute nuevamente con los datos.${SCOLOR}"
        exit 0
    fi

    ns=$(sed -n 1p $HOME/credenciales)
    chave=$(sed -n 2p $HOME/credenciales)
fi

# DNS por defecto
dns="$3"
[[ -z "$dns" ]] && dns="8.8.8.8"

echo -e "\n${YELLOW}IMPORTANTE:${SCOLOR}"
echo -e "${GREEN}Active únicamente los DATOS MÓVILES antes de continuar.${SCOLOR}"
read -p "Presione ENTER para conectar..."

# Iniciar SlowDNS
$HOME/dns -udp ${dns}:53 -pubkey ${chave} ${ns} 127.0.0.1:2222 > /dev/null 2>&1 &
PID_DNS=$!

sleep 2

if ps -p $PID_DNS > /dev/null 2>&1; then
    echo -e "\n${GREEN}✔ SlowDNS iniciado correctamente.${SCOLOR}"
    echo -e "${YELLOW}Ahora conecte su app VPN.${SCOLOR}"
    read -p "Presione ENTER para desconectar..."
    kill $PID_DNS > /dev/null 2>&1
    echo -e "${RED}Conexión detenida.${SCOLOR}"
else
    echo -e "\n${RED}Error al iniciar SlowDNS.${SCOLOR}"
fi