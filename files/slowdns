#!/usr/bin/env bash
clear
# ==================================================
# CLIENTE SLOWDNS TERMUX - SINNOMBRE22 PRO
# ==================================================

# ðŸ“Œ COLORES OFICIALES
R='\033[0;31m'; G='\033[0;32m'; Y='\033[1;33m'
W='\033[1;37m'; CYAN='\033[0;36m'; RESET='\033[0m'
BOLD='\033[1m'
ROJO="\e[31m"; BLANCO="\e[97m"

LINEA="${ROJO}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• / / / â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"

banner='
 ___ _    _____      _____  _  _ ___ 
/ __| |  / _ \ \    / /   \| \| / __|
\__ \ |_| (_) \ \/\/ /| |) | .  \__ \
|___/____\___/ \_/\_/ |___/|_|\_|___/
'

# ==================================================
# TÃTULO
# ==================================================
echo -e "$LINEA"
echo -e "${BOLD}${BLANCO}           CLIENTE SSHPLUS SLOWDNS - SINNOMBRE22           ${RESET}"
echo -e "$LINEA"
echo -e "${R}$banner${RESET}"

# ==================================================
# DESCARGAR COMPONENTE DNS
# ==================================================
if [[ ! -f "$HOME/dns" ]]; then
    echo -e "\n${Y}Descargando componente DNS...${RESET}"
    pkg install curl -y > /dev/null 2>&1
    curl -s -o $HOME/dns https://raw.githubusercontent.com/khaledagn/DNS-AGN/main/files/dns
    chmod +x $HOME/dns

    if [[ -f "$HOME/dns" ]]; then
        echo -e "${G}âœ” Componente descargado correctamente${RESET}"
    else
        echo -e "${R}âœ– Error al descargar componente DNS${RESET}"
        exit 1
    fi
fi

# ==================================================
# CONFIGURAR CREDENCIALES
# ==================================================
if [[ ! -f "$HOME/credenciales" ]]; then
    ns="$1"
    chave="$2"

    if [[ -z "$ns" || -z "$chave" ]]; then
        echo -e "\n${R}Uso correcto:${RESET}"
        echo -e "${Y}slowdns <NS> <CLAVE_PUBLICA> [DNS_IP]${RESET}"
        exit 1
    fi

    echo -e "$ns\n$chave" > $HOME/credenciales
else
    echo -e "\n${Y}ConfiguraciÃ³n detectada${RESET}"
    read -p "$(echo -e "${G}Â¿Desea continuar con la misma configuraciÃ³n? (s/n): ${RESET}")" opc

    if [[ ! "$opc" =~ ^(s|S|si|SI)$ ]]; then
        rm -f $HOME/credenciales
        echo -e "${R}ConfiguraciÃ³n eliminada. Ejecute nuevamente con los datos.${RESET}"
        exit 0
    fi

    ns=$(sed -n 1p $HOME/credenciales)
    chave=$(sed -n 2p $HOME/credenciales)
fi

# ==================================================
# DNS POR DEFECTO
# ==================================================
dns="$3"
[[ -z "$dns" ]] && dns="8.8.8.8"

echo -e "\n${Y}IMPORTANTE:${RESET}"
echo -e "${G}Active Ãºnicamente los DATOS MÃ“VILES antes de continuar${RESET}"
read -p "Presione ENTER para conectar..."

# ==================================================
# INICIAR SLOWDNS
# ==================================================
$HOME/dns -udp ${dns}:53 -pubkey ${chave} ${ns} 127.0.0.1:2222 > /dev/null 2>&1 &
PID_DNS=$!

sleep 2

if ps -p $PID_DNS > /dev/null 2>&1; then
    echo -e "\n${G}âœ” SlowDNS iniciado correctamente${RESET}"
    echo -e "${Y}Ahora conecte su aplicaciÃ³n VPN${RESET}"
    read -p "Presione ENTER para desconectar..."

    kill $PID_DNS > /dev/null 2>&1
    echo -e "${R}âœ– ConexiÃ³n detenida${RESET}"
else
    echo -e "\n${R}âœ– Error al iniciar SlowDNS${RESET}"
fi

echo -e "$LINEA"