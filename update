#!/bin/bash

clear

# =============================
# BARRA DE PROGRESO
# =============================
fun_bar() {
    (
        $1 > /dev/null 2>&1
        touch $HOME/fim
    ) &

    tput civis
    echo -ne "  ESPERANDO ["
    while true; do
        for ((i=0; i<18; i++)); do
            echo -ne "#"
            sleep 0.1
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -ne "]"
        sleep 1
        tput cuu1
        tput dl1
        echo -ne "  ESPERANDO ["
    done
    echo -e "] OK"
    tput cnorm
}

# =============================
# AVISO
# =============================
echo "========================================"
echo "        ATENCIÓN IMPORTANTE"
echo "========================================"
echo ""
echo "Al finalizar el proceso deberás"
echo "configurar nuevamente el servicio SlowDNS."
echo ""
echo "Selecciona la opción:"
echo "'Usar clave actual' para restaurar tu clave anterior."
echo ""
read -p "Presiona [ENTER] para continuar o CTRL + C para cancelar"

echo ""
echo "ELIMINANDO ARCHIVOS ANTIGUOS..."
echo ""

# =============================
# ELIMINAR INSTALACIÓN ANTERIOR
# =============================
fun_remove() {

    cd /root || exit 1

    wget -q https://raw.githubusercontent.com/powermx/dnstt/main/remove-slow -O remove-slow
    chmod +x remove-slow
    bash remove-slow

    sleep 2

    rm -f /bin/slowdns
    rm -rf /etc/slowdns
    rm -f /root/remove-slow
}

fun_bar fun_remove

echo ""
echo "ACTUALIZANDO SCRIPT..."
echo ""

# =============================
# DESCARGAR NUEVA VERSIÓN
# =============================
fun_update() {

    cd /root || exit 1

    wget -q https://raw.githubusercontent.com/powermx/dnstt/main/install -O install
    chmod +x install
    bash install
}

fun_bar fun_update

sleep 2

echo ""
echo "✔ SLOWDNS ACTUALIZADO CORRECTAMENTE"
echo ""
echo "Para abrir el menú usa el comando:"
echo ""
echo "   slowdns"
echo ""
read -p "Presiona [ENTER] para finalizar..."