#!/usr/bin/env bash
export TERM=xterm-256color
export DEBIAN_FRONTEND=noninteractive

# ===== COLORES ESTABLES (TPUT) =====
ROJO=$(tput setaf 1)
VERDE=$(tput setaf 2)
AMARILLO=$(tput setaf 3)
CYAN=$(tput setaf 6)
BLANCO=$(tput setaf 7)
BOLD=$(tput bold)
RESET=$(tput sgr0)

LINEA="${ROJO}══════════════════════════ / / / ══════════════════════════${RESET}"

# ===== BARRA DE PROGRESO =====
barra_progreso() {
    tput civis
    echo -ne "  ${CYAN}ESPERANDO ${ROJO}["
    for i in {1..20}; do
        echo -ne "#"
        sleep 0.05
    done
    echo -e "] ${VERDE}OK!${RESET}"
    tput cnorm
}

# ===== LOGO =====
mostrar_logo() {
    clear
    echo -e "$LINEA"

    LOGO=$(figlet -f slant SlowDNS)
    echo "${AMARILLO}${LOGO}${RESET}"

    echo -e "$LINEA"
    echo -e "${BOLD}${BLANCO}                INSTALADOR OFICIAL SINNOMBRE22                ${RESET}"
    echo -e "$LINEA"
}

# ===== CONFIGURAR FIREWALL =====
configurar_firewall() {
    systemctl enable firewalld >/dev/null 2>&1
    systemctl start firewalld >/dev/null 2>&1

    firewall-cmd --zone=public --permanent --add-port=53/udp >/dev/null 2>&1
    firewall-cmd --zone=public --permanent --add-port=5300/udp >/dev/null 2>&1
    firewall-cmd --reload >/dev/null 2>&1
}

# ===== CONFIGURAR DNS =====
configurar_dns() {
    echo "nameserver 1.1.1.1" > /etc/resolv.conf
}

# ===== INSTALAR SLOWDNS =====
instalar_slowdns() {
    mostrar_logo
    echo
    echo -e "${CYAN}Instalando dependencias...${RESET}"
    barra_progreso

    apt update -y >/dev/null 2>&1
    apt install wget figlet firewalld -y >/dev/null 2>&1

    mkdir -p /etc/slowdns
    cd /etc/slowdns || exit

    wget -q https://raw.githubusercontent.com/powermx/dnstt/main/dns-server -O dns-server
    chmod +x dns-server

    configurar_firewall
    configurar_dns

    echo
    echo -e "${VERDE}✔ SlowDNS instalado correctamente${RESET}"
    sleep 2
}

# ===== MENÚ PRINCIPAL =====
menu() {
    while true; do
        mostrar_logo
        echo

        if command -v dns-server >/dev/null 2>&1; then
            echo -e "${VERDE}1)${CYAN} Reinstalar SlowDNS${RESET}"
            echo -e "${VERDE}0)${CYAN} Salir${RESET}"
        else
            echo -e "${ROJO}✖ SlowDNS no está instalado${RESET}"
            echo
            echo -e "${VERDE}1)${CYAN} Instalar SlowDNS${RESET}"
            echo -e "${VERDE}0)${CYAN} Salir${RESET}"
        fi

        echo
        read -p "Seleccione una opción: " op

        case $op in
            1) instalar_slowdns ;;
            0) exit ;;
            *) ;;
        esac
    done
}

menu