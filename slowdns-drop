#!/bin/bash

# =============================
# VERIFICAR ROOT
# =============================
if [[ $EUID -ne 0 ]]; then
   echo "Este script debe ejecutarse como root"
   exit 1
fi

clear

# =============================
# COLORES OFICIALES
# =============================
R='\033[0;31m'; G='\033[0;32m'; Y='\033[1;33m'; B='\033[0;34m'
M='\033[0;35m'; C='\033[0;36m'; W='\033[1;37m'; N='\033[0m'
BOLD='\033[1m'
ROJO="\e[31m"; BLANCO="\e[97m"; CYAN="\e[36m"; AMARILLO="\e[33m"; RESET="\e[0m"

LINEA="${ROJO}══════════════════════════ / / / ══════════════════════════${RESET}"

# =============================
# BARRA OFICIAL
# =============================
fun_bar() {
    (
        eval "$1" > /dev/null 2>&1
        touch $HOME/fim
    ) &

    tput civis
    echo -ne "  ${CYAN}PROCESANDO${RESET} ${ROJO}["
    while true; do
        for ((i=0;i<18;i++)); do
            echo -ne "${ROJO}#${RESET}"
            sleep 0.1
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -ne "${ROJO}]${RESET}"
        sleep 1
        tput cuu1 && tput dl1
        echo -ne "  ${CYAN}PROCESANDO${RESET} ${ROJO}["
    done
    echo -e "${ROJO}]${RESET} ${G}OK${RESET}"
    tput cnorm
}

# =============================
# ENCABEZADO
# =============================
echo -e "$LINEA"
echo -e "${BOLD}${BLANCO}               INSTALADOR SLOWDNS DROPBEAR               ${RESET}"
echo -e "$LINEA"
echo ""

# =============================
# ACTUALIZAR SISTEMA
# =============================
echo -e "${AMARILLO}Actualizando sistema...${RESET}"
fun_bar "apt update -y && apt upgrade -y"

# =============================
# INSTALAR DEPENDENCIAS
# =============================
echo -e "${AMARILLO}Instalando dependencias...${RESET}"
fun_bar "apt install screen cron iptables -y"

mkdir -p /etc/slowdns

# =============================
# DESCARGAR BINARIO DNSTT
# =============================
echo -e "${AMARILLO}Descargando binario DNSTT...${RESET}"
fun_bar "cd /etc/slowdns && wget -q https://github.com/SINNOMBRE22/dnstt/raw/main/dns-server && chmod +x dns-server"

# =============================
# FIREWALL
# =============================
configurar_firewall() {
iptables -C INPUT -p udp --dport 5300 -j ACCEPT 2>/dev/null || \
iptables -I INPUT -p udp --dport 5300 -j ACCEPT

iptables -t nat -C PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 5300 2>/dev/null || \
iptables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 5300
}
echo -e "${AMARILLO}Configurando firewall...${RESET}"
fun_bar configurar_firewall

# =============================
# INICIO AUTOMÁTICO
# =============================
configurar_inicio() {
RC="/etc/rc.local"
if [ ! -f "$RC" ]; then
    echo -e "#!/bin/bash\n\nexit 0" > $RC
    chmod +x $RC
fi
LINE='cd /etc/slowdns && ./startdns'
grep -Fxq "$LINE" "$RC" || sed -i "/^exit 0/i $LINE" "$RC"
}
echo -e "${AMARILLO}Configurando inicio automático...${RESET}"
fun_bar configurar_inicio

# =============================
# PEDIR NS
# =============================
echo ""
read -p "Ingresa tu NS (Nameserver): " nameserver
echo "$nameserver" > /etc/slowdns/infons

# =============================
# DESCARGAR SCRIPTS DROPBEAR
# =============================
echo -e "${AMARILLO}Descargando scripts DROPBEAR...${RESET}"
fun_bar "cd /etc/slowdns && \
wget -q https://raw.githubusercontent.com/SINNOMBRE22/dnstt/main/drop/startdns && \
wget -q https://raw.githubusercontent.com/SINNOMBRE22/dnstt/main/drop/restartdns && \
chmod +x startdns restartdns && \
sed -i 's;1234;$nameserver;g' startdns restartdns && \
cp startdns restartdns /bin/"

cd /root

# =============================
# CLAVES
# =============================
echo -e "$LINEA"
echo -e "${BOLD}${BLANCO}                    CONFIGURAR CLAVES                    ${RESET}"
echo -e "$LINEA"
echo ""

if [[ -f server.key && -f server.pub ]]; then
    echo -e "${CYAN}[1]${RESET} Usar claves existentes"
    echo -e "${CYAN}[2]${RESET} Generar nuevas claves"
    echo -e "${CYAN}[3]${RESET} Descargar claves por defecto"
    echo -e "${ROJO}[x] Cancelar${RESET}"
else
    echo -e "${CYAN}[1]${RESET} Generar nuevas claves"
    echo -e "${CYAN}[2]${RESET} Descargar claves por defecto"
    echo -e "${ROJO}[x] Cancelar${RESET}"
fi

read -p "Selecciona una opción: " opcion

case $opcion in
1)
    echo -e "${AMARILLO}Usando claves actuales...${RESET}"
    ;;
2)
    echo -e "${AMARILLO}Generando nuevas claves...${RESET}"
    rm -f server.key server.pub
    cd /etc/slowdns
    ./dns-server -gen-key -privkey-file /root/server.key -pubkey-file /root/server.pub
    ;;
3)
    echo -e "${AMARILLO}Descargando claves por defecto...${RESET}"
    cd /root
    wget -q https://raw.githubusercontent.com/SINNOMBRE22/dnstt/main/server.key
    wget -q https://raw.githubusercontent.com/SINNOMBRE22/dnstt/main/server.pub
    ;;
x)
    echo -e "${ROJO}Instalación cancelada.${RESET}"
    exit
    ;;
*)
    echo -e "${ROJO}Opción inválida.${RESET}"
    exit
    ;;
esac

# =============================
# FINALIZAR
# =============================
cp /root/server.key /root/server.pub /etc/slowdns/
configurar_firewall
cd /etc/slowdns && ./startdns

clear
echo ""
echo -e "$LINEA"
echo -e "${G}                 ✔ INSTALACIÓN COMPLETADA                 ${RESET}"
echo -e "$LINEA"
echo ""
echo -e "${AMARILLO}Tu NS:${RESET} $(cat /etc/slowdns/infons)"
echo ""
echo -e "${AMARILLO}Tu clave pública:${RESET}"
cat /root/server.pub
echo ""
echo -e "${AMARILLO}Comando para Termux:${RESET}"
echo "curl -sO https://github.com/SINNOMBRE22/dnstt/raw/main/files/slowdns && chmod +x slowdns && ./slowdns $(cat /etc/slowdns/infons) $(cat /root/server.pub)"
echo ""
echo -e "${AMARILLO}La clave está guardada en:${RESET} /root/server.pub"
echo ""
read -p "Presiona ENTER para continuar..."
slowdns