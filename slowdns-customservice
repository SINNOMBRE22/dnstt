#!/bin/bash

# Verificar root
if [[ $EUID -ne 0 ]]; then
    echo "Este script debe ejecutarse como root"
    exit 1
fi

clear

# Colores
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
WHITE='\033[1;37m'
RESET='\033[0m'

# Barra limpia
fun_bar() {
    (
        eval "$1" > /dev/null 2>&1
        touch $HOME/fim
    ) &
    tput civis
    echo -ne "  PROCESANDO ["
    while true; do
        for ((i=0;i<18;i++)); do
            echo -ne "#"
            sleep 0.1
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -ne "]"
        sleep 1
        tput cuu1 && tput dl1
        echo -ne "  PROCESANDO ["
    done
    echo -e "] OK"
    tput cnorm
}

echo -e "${RED}════════════════════════════════════════════${RESET}"
echo -e "${GREEN} INSTALADOR SLOWDNS SERVICIO PERSONALIZADO${RESET}"
echo -e "${RED}════════════════════════════════════════════${RESET}"
echo ""

echo "Actualizando sistema..."
fun_bar "apt update -y && apt upgrade -y"

echo "Instalando dependencias..."
fun_bar "apt install screen cron iptables wget -y"

# Crear carpeta
mkdir -p /etc/slowdns

echo "Descargando binario DNSTT..."
fun_bar "cd /etc/slowdns && wget -q https://github.com/powermx/dnstt/raw/main/dns-server && chmod +x dns-server"

# Firewall seguro
configurar_firewall() {
iptables -C INPUT -p udp --dport 5300 -j ACCEPT 2>/dev/null || \
iptables -I INPUT -p udp --dport 5300 -j ACCEPT

iptables -t nat -C PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 5300 2>/dev/null || \
iptables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 5300
}

fun_bar configurar_firewall

# Configurar inicio automático sin romper rc.local
configurar_inicio() {
RC="/etc/rc.local"
if [ ! -f "$RC" ]; then
    echo -e "#!/bin/bash\n\nexit 0" > $RC
    chmod +x $RC
fi
LINE='cd /etc/slowdns && ./startdns'
grep -Fxq "$LINE" "$RC" || sed -i "/^exit 0/i $LINE" "$RC"
}
fun_bar configurar_inicio

echo ""
read -p "Ingresa tu NS (Nameserver): " nameserver
echo "$nameserver" > /etc/slowdns/infons

echo ""
read -p "Ingresa el puerto del servicio (NO usar 53 ni 5300): " customport

if [[ "$customport" == "53" || "$customport" == "5300" ]]; then
    echo -e "${RED}ERROR: No puedes usar el puerto 53 ni 5300${RESET}"
    exit 1
fi

# Crear startdns
cat <<EOF > /etc/slowdns/startdns
#!/bin/bash
screen -dmS slowdns$customport /etc/slowdns/dns-server -udp :5300 -privkey-file /root/server.key $nameserver 127.0.0.1:$customport
EOF

# Crear restartdns
cat <<EOF > /etc/slowdns/restartdns
#!/bin/bash
screen -ls | grep slowdns | cut -d. -f1 | awk '{print \$1}' | xargs kill 2>/dev/null
screen -dmS slowdns$customport /etc/slowdns/dns-server -udp :5300 -privkey-file /root/server.key $nameserver 127.0.0.1:$customport
EOF

chmod +x /etc/slowdns/startdns
chmod +x /etc/slowdns/restartdns
cp /etc/slowdns/startdns /bin/
cp /etc/slowdns/restartdns /bin/

cd /root

# Manejo de claves
if [[ ! -f server.key || ! -f server.pub ]]; then
    echo "Generando nuevas claves..."
    cd /etc/slowdns
    ./dns-server -gen-key -privkey-file /root/server.key -pubkey-file /root/server.pub
fi

cp /root/server.key /root/server.pub /etc/slowdns/

# Iniciar servicio
cd /etc/slowdns
./startdns

clear
echo -e "${GREEN}INSTALACIÓN COMPLETADA ✔${RESET}"
echo ""
echo -e "${YELLOW}Tu NS:${WHITE} $(cat /etc/slowdns/infons)"
echo ""
echo -e "${YELLOW}Tu clave pública:${WHITE}"
cat /root/server.pub
echo ""
echo -e "${YELLOW}Puerto configurado:${WHITE} $customport"
echo ""
echo -e "${YELLOW}La clave está guardada en:${WHITE} /root/server.pub"
echo ""
read -p "Presiona ENTER para volver al menú..."
slowdns