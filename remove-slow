#!/bin/bash
# Remove SlowDNS - SINNOMBRE22

fun_bar () {
comando="$1"
(
[[ -e $HOME/fim ]] && rm $HOME/fim
$comando > /dev/null 2>&1
touch $HOME/fim
) > /dev/null 2>&1 &
tput civis
echo -ne "  \033[1;33mPROCESANDO \033[1;37m- \033[1;33m["
while true; do
   for((i=0; i<18; i++)); do
      echo -ne "\033[1;31m#"
      sleep 0.1s
   done
   [[ -e $HOME/fim ]] && rm $HOME/fim && break
   echo -e "\033[1;33m]"
   sleep 1s
   tput cuu1
   tput dl1
   echo -ne "  \033[1;33mPROCESANDO \033[1;37m- \033[1;33m["
done
echo -e "\033[1;33m]\033[1;37m - \033[1;32mOK!\033[0m"
tput cnorm
}

clear
echo "═══════════════════════════════════════════════"
echo "        DESINSTALADOR SLOWDNS - SINNOMBRE22"
echo "═══════════════════════════════════════════════"
echo ""

cd /root

echo "Deteniendo servicio SlowDNS..."

fun_stop () {
screen -ls | grep slowdns | awk '{print $1}' | xargs -r kill
sleep 2
}
fun_bar fun_stop

echo ""
echo "Restaurando configuración del sistema..."

fun_restore () {
if [ -f /etc/rc.local.bkp ]; then
    rm -f /etc/rc.local
    mv /etc/rc.local.bkp /etc/rc.local
    chmod +x /etc/rc.local
fi
sleep 2
}
fun_bar fun_restore

echo ""
echo "Restaurando DNS del sistema..."

fun_revdns () {
echo "nameserver 8.8.8.8" > /etc/resolv.conf
systemctl enable systemd-resolved.service >/dev/null 2>&1
systemctl restart systemd-resolved.service >/dev/null 2>&1
sleep 2
}
fun_bar fun_revdns

echo ""
echo "Eliminando archivos de SlowDNS..."

fun_remove_files () {
rm -rf /etc/slowdns
rm -f /bin/startdns
rm -f /bin/restartdns
rm -f /bin/stopdns
sleep 2
}
fun_bar fun_remove_files

echo ""
echo -e "\033[1;32mSlowDNS eliminado correctamente ✔\033[0m"
echo ""
read -p "Presiona ENTER para continuar..."

# Volver al menú si existe
if command -v slowdns >/dev/null 2>&1; then
    slowdns
else
    exit
fi