#!/bin/bash
# ===============================================
# DESINSTALADOR SLOWDNS - SINNOMBRE22
# ===============================================

# Colores oficiales SINNOMBRE22
R='\033[0;31m'; G='\033[0;32m'; Y='\033[1;33m'; B='\033[0;34m'
M='\033[0;35m'; C='\033[0;36m'; W='\033[1;37m'; N='\033[0m'
BOLD='\033[1m'
ROJO="\e[31m"; BLANCO="\e[97m"; CYAN="\e[36m"; AMARILLO="\e[33m"; RESET="\e[0m"

# Línea roja oficial
LINEA="${ROJO}══════════════════════════ / / / ══════════════════════════${RESET}"

# Barra de progreso oficial
fun_bar () {
comando="$1"
(
[[ -e $HOME/fim ]] && rm $HOME/fim
$comando > /dev/null 2>&1
touch $HOME/fim
) > /dev/null 2>&1 &
tput civis
echo -ne "  ${CYAN}ESPERANDO ${BLANCO}["
while true; do
   for((i=0; i<18; i++)); do
      echo -ne "${ROJO}#"
      sleep 0.1s
   done
   [[ -e $HOME/fim ]] && rm $HOME/fim && break
   echo -e "${BLANCO}]"
   sleep 1
   tput cuu1
   tput dl1
   echo -ne "  ${CYAN}ESPERANDO ${BLANCO}["
done
echo -e "${BLANCO}] ${G}OK!${RESET}"
tput cnorm
}

# Encabezado centrado oficial
clear
echo -e "$LINEA"
echo -e "${BOLD}${BLANCO}                DESINSTALADOR SLOWDNS                ${RESET}"
echo -e "$LINEA"
echo ""

cd /root

# Detener servicio
echo "Deteniendo servicio SlowDNS..."
fun_stop () {
screen -ls | grep slowdns | awk '{print $1}' | xargs -r kill
sleep 2
}
fun_bar fun_stop

# Restaurar configuración
echo ""
echo "Restaurando configuración del sistema..."
fun_restore () {
if [ -f /etc/rc.local.bkp ]; then
    rm -f /etc/rc.local
    mv /etc/rc.local.bkp /etc/rc.local
    chmod +x /etc/rc.local
fi
sleep 2
}
fun_bar fun_restore

# Restaurar DNS
echo ""
echo "Restaurando DNS del sistema..."
fun_revdns () {
echo "nameserver 8.8.8.8" > /etc/resolv.conf
systemctl enable systemd-resolved.service >/dev/null 2>&1
systemctl restart systemd-resolved.service >/dev/null 2>&1
sleep 2
}
fun_bar fun_revdns

# Eliminar archivos
echo ""
echo "Eliminando archivos de SlowDNS..."
fun_remove_files () {
rm -rf /etc/slowdns
rm -f /bin/startdns
rm -f /bin/restartdns
rm -f /bin/stopdns
sleep 2
}
fun_bar fun_remove_files

# Mensaje final oficial
echo ""
echo -e "${G}✔ SlowDNS eliminado correctamente${RESET}"
echo ""
read -p "Presiona ENTER para continuar..."

# Volver al menú si existe
if command -v slowdns >/dev/null 2>&1; then
    slowdns
else
    exit
fi